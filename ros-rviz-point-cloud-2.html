<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="imports.html">

<dom-module id="ros-rviz-point-cloud-2">
  <template>
    <paper-input label="Topic" value="{{topic}}"></paper-input>
    <paper-input label="Size" value="{{size}}"></paper-input>
    <paper-input label="Color source" value="{{colorSource}}"></paper-input>
    <paper-checkbox checked={{applyRGB8PCT}} value={{applyRGB8PCT}}>
      Apply RGB8 color transformation
    </paper-checkbox>
  </template>
  <script>
    Polymer({
      is: 'ros-rviz-point-cloud-2',

      properties: {
        name: {
          type: String,
          value: 'Point cloud 2',
        },
        topic: {
          type: String,
          value: '',
          notify: true, 
        },
        size: {
          type: Number,
          value: 0.01,
          notify: true,
        },
        colorSource: {
          type: String,
          value: 'rgb',
          notify: true,
        },
        applyRGB8PCT: {
          type: Boolean,
          value: true,
          notify: true,
        },
        globalOptions: Object,
        isShown: Boolean,
        ros: Object,
        tfClient: Object,
        viewer: Object,
        _pc2: Object,
      },

      observers: [
        '_optionsChanged(topic, size, colorSource, applyRGB8PCT, viewer, ros)',
      ],

      destroy: function() {
        if (this._pc2) {
          this._pc2.unsubscribe();
          this.viewer.scene.remove(this._pc2.points.sn);
          delete this._pc2;
        }
      },

      hide: function() {
        if (this._pc2) {
          this._pc2.unsubscribe();
          this.viewer.scene.remove(this._pc2.points.sn);
          delete this._pc2;
        }
      },

      show: function() {
        if (this.isShown) {
          this._updateDisplay();
        }
      },

      _optionsChanged: function(topic, size, colorSource, applyRGB8PCT, viewer, ros) {
        var that = this;
        this.debounce('updateForOptions', function() {
          that.hide();
          that.show();
        }, 200);
      },

      _updateDisplay: function(callback) {
        if (!(this.ros && this.tfClient && this.topic)) {
          return;
        }
        this.destroy();
        this._rgb_lut = new Float32Array(256);
        for (var i = 0; i < 256; i++) {
          this._rgb_lut[i] = i / 255.0
        }
        this._floatColor = new Float32Array(1);
        var that = this;

        let colormap = undefined;
        if (this.applyRGB8PCT) {
          colormap = function(x) {
            that._floatColor[0] = x;
            const intColorArray = new Int32Array(that._floatColor.buffer);
            const intColor = intColorArray[0];

            return {
              r: that._rgb_lut[(intColor >> 16) & 0xff],
              g: that._rgb_lut[(intColor >> 8) & 0xff],
              b: that._rgb_lut[(intColor) & 0xff],
              a: 1.0
            };
          }
        }

        this._pc2 = new ROS3D.PointCloud2({
          ros: this.ros,
          topic: this.topic,
          material: {
            size: this.size,
          },
          colorsrc: this.colorSource,
          max_pts: 307200,
          tfClient: this.tfClient,
          rootObject: this.viewer.scene,
          colormap: colormap
        });

        callback && callback();
      },
    });
  </script>
</dom-module>
